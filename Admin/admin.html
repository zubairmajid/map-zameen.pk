<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-Users</title>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="sidebar">
        <a href="https://test.mustafapro.com/Admin/admin.html" style="text-decoration: none; color: inherit;">
            <h2 class="admin-panel-title">Admin Panel</h2>
        </a>
        
        <h3>Users</h3>
        <button id="add-user-btn"><i class="fas fa-user-plus"></i> Add User</button>
        <button id="change-password-btn"><i class="fas fa-key"></i> Change Password</button>
        <button id="delete-user-btn"><i class="fas fa-user-minus"></i> Delete User</button>
        <button id="manage-role-btn"><i class="fas fa-user-shield"></i> Manage Roles</button>
        <button id="new-users-btn"><i class="fas fa-users"></i> New Users</button>

        <h3>HTML Section</h3>
        <button id="assign-html-btn"><i class="fas fa-file-code"></i> Assign HTML</button>
        <button id="update-html-btn"><i class="fas fa-file-upload"></i> Update HTML</button>
    </div>
    <div class="welcome-message" id="welcome-message">
        <h1>Welcome to Admin Dashboard</h1>
    </div>
    <div class="logout-container">
        <button id="logout-btn">Logout</button>
    </div>

    <!-- Add User Content -->
    <div class="content" id="add-user-content">
        <h1>Add User</h1>
        <form id="signup-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="submit">Sign Up</button>
            <div class="error" id="error-message"></div>
        </form>
    </div>

    <!-- Change Password Content -->
    <div class="content" id="change-password-content" style="display: none;">
        <h1>Change User Password</h1>
        <form id="change-password-form">
            <input type="email" id="change-email" placeholder="User Email" required>
            <input type="password" id="new-password" placeholder="New Password" required>
            <button type="submit" class="submit">Change Password</button>
            <div class="error" id="change-error-message"></div>
        </form>
    </div>

    <!-- Delete User Content -->
    <div class="content" id="delete-user-content" style="display: none;">
        <h1>Delete User</h1>
        <form id="delete-user-form">
            <input type="email" id="delete-email" placeholder="User Email" required>
            <input type="password" id="delete-password" placeholder="Password" required>
            <button type="submit" class="submit">Delete User</button>
            <div class="error" id="delete-error-message"></div>
        </form>

        <!-- New Option for Deleting from Database -->
        <h2>Delete from Database</h2>
        <form id="delete-user-by-uid-form">
            <input type="text" id="delete-uid" placeholder="User UID" required>
            <button type="submit" class="submit">Delete User by UID</button>
            <div class="error" id="delete-uid-error-message"></div>
        </form>
    </div>

    <!-- Manage User Role Content -->
    <div class="content" id="manage-role-content" style="display: none;">
        <h1>Manage User Roles</h1>
        <form id="admin-role-form">
            <input type="text" id="role-uid" placeholder="User UID" required>
            <button type="button" id="assign-admin-btn">Assign Admin Role</button>
            <button type="button" id="remove-admin-btn">Remove Admin Role</button>
            <button type="button" id="enable-user-btn">Enable User</button>
            <button type="button" id="disable-user-btn">Disable User</button>
            <div class="success" id="role-success-message"></div>
            <div class="error" id="role-error-message"></div>
        </form>
    </div>

    <!-- Assign HTML Content -->
    <div class="content" id="assign-html-content" style="display: none;">
        <h1>Assign HTML to User</h1>
        <form id="assign-html-form">
            <input type="text" id="assign-uid" placeholder="User UID" required>
            <input type="text" id="html-link" placeholder="HTML File Link" required>
            <button type="submit" class="submit">Assign HTML</button>
            <div class="error" id="assign-error-message"></div>
        </form>
    </div>

    <!-- Update Assigned HTML Content -->
    <div class="content" id="update-html-content" style="display: none;">
        <h1>Update Assigned HTML for User</h1>
        <form id="update-html-form">
            <input type="text" id="update-uid" placeholder="User UID" required>
            <input type="text" id="update-html-link" placeholder="New HTML File Link" required>
            <button type="submit" class="submit">Update HTML</button>
            <div class="error" id="update-error-message"></div>
        </form>
    </div>

    <!-- New Users Content -->
    <div class="content" id="new-users-content" style="display: none;">
        <h1>New Users</h1>
        <table id="new-users-table">
            <thead>
                <tr>
                    <th>Serial No</th>
                    <th>Email</th>
                    <th>User UID</th>
                    <th>Date of Creation</th>
                    <th>Assigned HTML File</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="new-users-tbody">
                <!-- New users list will be populated here -->
            </tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, deleteUser, signInWithEmailAndPassword, updatePassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDpE3P5p8qmjqrCpWkCO_GByLLGN6T0d8Q",
            authDomain: "digimap-6e7b3.firebaseapp.com",
            databaseURL: "https://digimap-6e7b3-default-rtdb.firebaseio.com",
            projectId: "digimap-6e7b3",
            storageBucket: "digimap-6e7b3.appspot.com",
            messagingSenderId: "822609711769",
            appId: "1:822609711769:web:a7f3ecd060611d9e771e08",
            measurementId: "G-9XC69NPN35"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Check authentication status
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "https://test.mustafapro.com/login.html"; // Redirect to login page if not authenticated
            }
        });

        // Navigation Handlers
        document.getElementById('add-user-btn').addEventListener('click', () => {
            showContent('add-user-content');
        });
        document.getElementById('change-password-btn').addEventListener('click', () => {
            showContent('change-password-content');
        });
        document.getElementById('delete-user-btn').addEventListener('click', () => {
            showContent('delete-user-content');
        });
        document.getElementById('manage-role-btn').addEventListener('click', () => {
            showContent('manage-role-content');
        });
        document.getElementById('new-users-btn').addEventListener('click', () => {
            showContent('new-users-content');
            loadNewUsers();
        });
        document.getElementById('assign-html-btn').addEventListener('click', () => {
            showContent('assign-html-content');
        });
        document.getElementById('update-html-btn').addEventListener('click', () => {
            showContent('update-html-content');
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "https://test.mustafapro.com/login.html"; // Redirect to login page after logout
            }).catch((error) => {
                console.error('Error during logout:', error);
            });
        });

        // Add User
        document.getElementById('signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    set(ref(db, 'users/' + user.uid), {
                        email: user.email,
                        uid: user.uid,
                        createdAt: new Date().toISOString(),
                    });
                    alert('User added successfully!');
                })
                .catch((error) => {
                    document.getElementById('error-message').innerText = error.message;
                });
        });

        // Change User Password
        document.getElementById('change-password-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('change-email').value;
            const newPassword = document.getElementById('new-password').value;
            signInWithEmailAndPassword(auth, email, document.getElementById('delete-password').value)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return updatePassword(user, newPassword);
                })
                .then(() => {
                    alert('Password changed successfully!');
                })
                .catch((error) => {
                    document.getElementById('change-error-message').innerText = error.message;
                });
        });

        // Delete User
        document.getElementById('delete-user-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('delete-email').value;
            const password = document.getElementById('delete-password').value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return deleteUser(user);
                })
                .then(() => {
                    alert('User deleted successfully!');
                })
                .catch((error) => {
                    document.getElementById('delete-error-message').innerText = error.message;
                });
        });

        // Delete User by UID
        document.getElementById('delete-user-by-uid-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const uid = document.getElementById('delete-uid').value;

            const userRef = ref(db, 'users/' + uid);
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    // If user exists, delete it
                    set(userRef, null)
                        .then(() => {
                            alert('User deleted from database successfully!');
                        })
                        .catch((error) => {
                            document.getElementById('delete-uid-error-message').innerText = error.message;
                        });
                } else {
                    document.getElementById('delete-uid-error-message').innerText = 'User not found!';
                }
            });
        });

        // Load New Users
        function loadNewUsers() {
            const newUsersRef = ref(db, 'users');
            onValue(newUsersRef, (snapshot) => {
                const users = snapshot.val();
                const tbody = document.getElementById('new-users-tbody');
                tbody.innerHTML = '';
                let serialNo = 1;

                for (const uid in users) {
                    const user = users[uid];
                    const row = `<tr>
                        <td>${serialNo++}</td>
                        <td>${user.email}</td>
                        <td>${user.uid}</td>
                        <td>${new Date(user.createdAt).toLocaleString()}</td>
                        <td>${user.htmlLink || 'Not Assigned'}</td>
                        <td>${user.status || 'Active'}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                }
            });
        }

        function showContent(contentId) {
            const contents = document.querySelectorAll('.content');
            contents.forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(contentId).style.display = 'block';
        }
    </script>
</body>
</html>
