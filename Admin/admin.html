<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-Users</title>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js"></script>
    <link rel="stylesheet" href="style/style.css">
</head>
<body>
    <div class="sidebar">
        <a href="https://test.mustafapro.com/Admin/admin.html" style="text-decoration: none; color: inherit;">
            <h2>Admin Panel</h2>
        </a>
        <button id="add-user-btn">Add User</button>
        <button id="assign-html-btn">Assign HTML</button>
        <button id="delete-user-btn">Delete User</button>
        <button id="view-users-btn">View Users</button>
        <button id="new-users-btn">New Users</button>
    </div>

    <!-- Welcome Message -->
    <div class="welcome-message" id="welcome-message">
        <h1>Welcome to Admin Dashboard</h1>
    </div>
    <div class="logout-container">
        <button id="logout-btn">Logout</button>
    </div>

    <!-- Add User Content -->
    <div class="content" id="add-user-content">
        <h1>Add User</h1>
        <form id="signup-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="submit">Sign Up</button>
            <div class="error" id="error-message"></div>
        </form>
    </div>

    <!-- Assign HTML Content -->
    <div class="content" id="assign-html-content" style="display: none;">
        <h1>Assign HTML to User</h1>
        <form id="assign-html-form">
            <input type="text" id="assign-uid" placeholder="User UID" required>
            <input type="text" id="html-link" placeholder="HTML File Link" required>
            <button type="submit" class="submit">Assign HTML</button>
            <div class="error" id="assign-error-message"></div>
        </form>
    </div>

    <!-- Delete User Content -->
    <div class="content" id="delete-user-content" style="display: none;">
        <h1>Delete User</h1>
        <form id="delete-user-form">
            <input type="email" id="delete-email" placeholder="User Email" required>
            <input type="password" id="delete-password" placeholder="Password" required>
            <button type="submit" class="submit">Delete User</button>
            <div class="error" id="delete-error-message"></div>
        </form>
    </div>

    <!-- View Users Content -->
    <div class="content" id="view-users-content" style="display: none;">
        <h1>View Users</h1>
        <table id="users-table">
            <thead>
                <tr>
                    <th>List No</th>
                    <th>User UID</th>
                    <th>Assigned HTML File</th>
                </tr>
            </thead>
            <tbody id="users-tbody">
                <!-- User list will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- New Users Content -->
    <div class="content" id="new-users-content" style="display: none;">
        <h1>New Users</h1>
        <table id="new-users-table">
            <thead>
                <tr>
                    <th>Serial No</th>
                    <th>Email</th>
                    <th>User UID</th>
                    <th>Date of Creation</th>
                </tr>
            </thead>
            <tbody id="new-users-tbody">
                <!-- New users list will be populated here -->
            </tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, deleteUser, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDpE3P5p8qmjqrCpWkCO_GByLLGN6T0d8Q",
            authDomain: "digimap-6e7b3.firebaseapp.com",
            databaseURL: "https://digimap-6e7b3-default-rtdb.firebaseio.com",
            projectId: "digimap-6e7b3",
            storageBucket: "digimap-6e7b3.appspot.com",
            messagingSenderId: "822609711769",
            appId: "1:822609711769:web:a7f3ecd060611d9e771e08",
            measurementId: "G-9XC69NPN35"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Check authentication status
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "https://test.mustafapro.com/login.html"; // Redirect to login page if not authenticated
            }
        });

        // Navigation Handlers
        document.getElementById('add-user-btn').addEventListener('click', () => {
            showContent('add-user-content');
        });
        document.getElementById('assign-html-btn').addEventListener('click', () => {
            showContent('assign-html-content');
        });
        document.getElementById('delete-user-btn').addEventListener('click', () => {
            showContent('delete-user-content');
        });
        document.getElementById('view-users-btn').addEventListener('click', () => {
            showContent('view-users-content');
            fetchUsers();
        });
        document.getElementById('new-users-btn').addEventListener('click', () => {
            showContent('new-users-content');
            fetchNewUsers();
        });

        function showContent(contentId) {
            const contents = document.querySelectorAll('.content');
            contents.forEach(content => content.style.display = 'none');
            document.getElementById(contentId).style.display = 'block';
            document.getElementById('welcome-message').style.display = 'none'; // Hide welcome message when navigating
        }

        // Fetch Users
        function fetchUsers() {
            const usersRef = ref(db, 'users/');
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';
            let listNo = 1;

            onValue(usersRef, (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const childKey = childSnapshot.key;
                    const childData = childSnapshot.val();
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${listNo++}</td><td>${childKey}</td><td>${childData.assignedFile || 'Not Assigned'}</td>`;
                    tbody.appendChild(row);
                });
            });
        }

        // Fetch New Users
        function fetchNewUsers() {
            const usersRef = ref(db, 'users/');
            const tbody = document.getElementById('new-users-tbody');
            tbody.innerHTML = '';
            let serialNo = 1;

            onValue(usersRef, (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    const userEmail = userData.email || 'N/A'; // Use email field
                    const dateCreated = userData.creationTime || 'N/A';
                    const uid = childSnapshot.key;

                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${serialNo++}</td><td>${userEmail}</td><td>${uid}</td><td>${dateCreated}</td>`;
                    tbody.appendChild(row);
                });
            });
        }

        // Sign Up User
        document.getElementById('signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    // Save user data in the database
                    set(ref(db, 'users/' + user.uid), {
                        email: email,
                        assignedFile: null,
                        creationTime: new Date().toISOString()
                    });
                    document.getElementById('error-message').innerText = 'User added successfully!';
                })
                .catch((error) => {
                    document.getElementById('error-message').innerText = error.message;
                });
        });

        // Assign HTML to User
        document.getElementById('assign-html-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const uid = document.getElementById('assign-uid').value;
            const htmlLink = document.getElementById('html-link').value;

            set(ref(db, 'users/' + uid + '/assignedFile'), htmlLink)
                .then(() => {
                    document.getElementById('assign-error-message').innerText = 'HTML file assigned successfully!';
                })
                .catch((error) => {
                    document.getElementById('assign-error-message').innerText = error.message;
                });
        });

        // Delete User
        document.getElementById('delete-user-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('delete-email').value;
            const password = document.getElementById('delete-password').value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    return deleteUser(user);
                })
                .then(() => {
                    document.getElementById('delete-error-message').innerText = 'User deleted successfully!';
                })
                .catch((error) => {
                    document.getElementById('delete-error-message').innerText = error.message;
                });
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "https://test.mustafapro.com/login.html"; // Redirect to login page on logout
            }).catch((error) => {
                console.error("Error during logout:", error);
            });
        });
    </script>
</body>
</html>
